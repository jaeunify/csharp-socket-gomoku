@page "/"
@using Microsoft.JSInterop
@inject IJSRuntime Js
@inject LogStore LogStore
@inject ServerClient ServerClient

<h3>TCP Echo Client</h3>

<div>
    <label>IP:</label>
    <input @bind="IpAddress" />
    <input type="checkbox" @bind="UseLocalhost" /> Use 127.0.0.1
</div>
<div>
    <label>Port:</label>
    <input type="number" @bind="Port" />
</div>
<div>
    <button @onclick="Connect">Connect</button>
    <button @onclick="Disconnect" disabled="@(!IsConnected)">Disconnect</button>
</div>
<div>
    <label>Send Text:</label>
    <input @bind="SendText" />
    <button @onclick="Send">Send</button>
</div>

<h4>Status: @StatusMessage</h4>

<ul>
    @foreach (var log in LogStore.Logs)
    {
        <li>@log</li>
    }
</ul>

@code {
    string IpAddress = "127.0.0.1";
    bool UseLocalhost = true;
    int Port = 32452;
    string SendText = "";
    string StatusMessage = "Not connected";

    bool IsConnected = false;

    protected override void OnInitialized()
    {
        LogStore.OnChange += HandleLogChange;
    }

    private void HandleLogChange()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        LogStore.OnChange -= HandleLogChange;
    }

    async Task Connect()
    {
        try
        {
            if (UseLocalhost) IpAddress = "127.0.0.1";
            ServerClient.Configure(IpAddress, Port);

            await ServerClient.ConnectAsync();

            IsConnected = true;
            StatusMessage = $"Connected to {IpAddress}:{Port}";
            LogStore.AddLog("서버에 접속 성공");
        }
        catch (Exception ex)
        {
            StatusMessage = $"Connection failed: {ex.Message}";
        }
    }

    void Disconnect()
    {
        if (IsConnected)
        {
            ServerClient.Disconnect();

            IsConnected = false;
            StatusMessage = "Disconnected";
            LogStore.AddLog("서버 접속이 끊어짐");
        }
    }

    async Task Send()
    {
        if (string.IsNullOrWhiteSpace(SendText))
        {
            await Js.InvokeVoidAsync("alert", "보낼 텍스트를 입력하세요");
            return;
        }

        if (!IsConnected)
        {
            LogStore.AddLog("서버 연결이 되어 있지 않습니다");
            return;
        }

        try
        {
            var packetSize = await ServerClient.SendAsync(SendText);
            LogStore.AddLog($"Echo 요청: {SendText}, {packetSize} bytes");
        }
        catch (Exception ex)
        {
            LogStore.AddLog($"Echo 요청 실패: {ex.Message}");
        }
    }

}
